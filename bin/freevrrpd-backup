#!/bin/sh -x
#
# - `filter reload` to apply interface `groups` to `ngeth0` interface
# - `interface reconfigure` to learn a newly born interface
# - `while ! drill` to wait for Unbound to start the service. Note, open tcp/53
#   does not mean that Unbound is actually ready to serve :-)
#   Note, the script does not wait for VPN gateway/DNS to be UP.

device="ngeth0"
interface=`/usr/local/bin/xmllint --xpath 'name(/opnsense/interfaces/*/if[text()="ngeth0"]/..)' /conf/config.xml`

/usr/local/sbin/configctl filter reload

/usr/local/sbin/configctl interface reconfigure "$interface"

# $device has no IP at this point and `reconfigure` does not grok that for some reason.
# However, `configctl` has hard time learning "no IP" situation and complains about it,
# so `interface newip` is not called here.

while ! drill -tQ . @localhost SOA IN; do sleep 1; done
